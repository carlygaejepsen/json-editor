<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Data Entry Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #33A7B5;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #33A7B5;
        }
        
        .facility-controls {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .facility-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .facility-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .facility-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .facility-btn.active {
            background: #33A7B5;
            color: white;
            border-color: #33A7B5;
        }
        
        .facility-btn:hover:not(.active) {
            background: #33A7B5;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-green {
            background: #33A7B5;
            color: white;
        }
        
        .btn-green:hover {
            background: #2a8c96;
        }
        
        .btn-red {
            background: #33A7B5;
            color: white;
        }
        
        .btn-red:hover {
            background: #2a8c96;
        }
        
        .btn-blue {
            background: #33A7B5;
            color: white;
        }
        
        .btn-blue:hover {
            background: #2a8c96;
        }
        
        .section {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8fafc;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .section-header:hover {
            background: #f1f5f9;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #33A7B5;
        }
        
        .section-toggle {
            font-size: 20px;
            color: #64748b;
            transition: transform 0.2s;
        }
        
        .section-content {
            padding: 20px;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .section.expanded .section-toggle {
            transform: rotate(180deg);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #33A7B5;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #33A7B5;
            box-shadow: 0 0 0 3px rgba(51, 167, 181, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .array-container {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }
        
        .array-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .array-item input {
            flex: 1;
        }
        
        .array-item button {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .add-item-btn {
            width: 100%;
            padding: 10px;
            background: #33A7B5;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .add-item-btn:hover {
            background: #2a8c96;
        }
        
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .document-card {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            background: white;
        }
        
        .document-card h4 {
            margin-bottom: 15px;
            color: #33A7B5;
            text-transform: capitalize;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .json-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .json-output pre {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .copy-btn {
            padding: 8px 16px;
            background: #33A7B5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .copy-btn:hover {
            background: #2a8c96;
        }
        
        .copy-btn:active {
            background: #2a8c96;
        }
        
        .upload-status {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .upload-status.success {
            background-color: #dcfce7;
            color: #33A7B5;
            border: 1px solid #bbf7d0;
        }
        
        .upload-status.error {
            background-color: #fef2f2;
            color: #33A7B5;
            border: 1px solid #fecaca;
        }
        
        .upload-status.info {
            background-color: #dbeafe;
            color: #33A7B5;
            border: 1px solid #93c5fd;
        }
        
        input[type="file"] {
            padding: 8px;
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        input[type="file"]:hover {
            border-color: #33A7B5;
            background: #eff6ff;
        }
        
        input[type="file"]:focus {
            outline: none;
            border-color: #33A7B5;
            box-shadow: 0 0 0 3px rgba(51, 167, 181, 0.1);
        }
        
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.2s;
        }
        
        .project-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .project-item.current {
            background: #eff6ff;
            border-color: #33A7B5;
        }
        
        .project-info {
            flex: 1;
        }
        
        .project-name {
            font-weight: 600;
            color: #33A7B5;
            margin-bottom: 2px;
        }
        
        .project-meta {
            font-size: 12px;
            color: #6b7280;
        }
        
        .project-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .project-management {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .debug-info {
            background: #fef7cd;
            border: 1px solid #33A7B5;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #33A7B5;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facility Data Entry Form</h1>
        
        <!-- Project Management Section (NOT collapsible) -->
        <div class="project-management">
            <h2 style="margin-bottom: 20px; color: #33A7B5;">Projects & Data Import</h2>
            
            <!-- Project Management -->
            <div class="form-group">
                <label>Project Management</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="text" id="project-name" placeholder="Enter project name..." style="flex: 1; min-width: 200px;">
                    <button class="btn btn-green" onclick="saveCurrentProject()">Save Project</button>
                    <button class="btn btn-blue" onclick="newProject()">New Project</button>
                </div>
                
                <div id="saved-projects" style="margin-bottom: 15px;">
                    <div id="current-project-info" style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: none;">
                        <strong>Current Project:</strong> <span id="current-project-name">Untitled</span>
                        <span style="font-size: 12px; color: #64748b; margin-left: 10px;" id="last-saved">Last saved: Never</span>
                    </div>
                    <div id="projects-list"></div>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: 1px solid #e2e8f0;">
            
            <!-- Import External JSON -->
            <div class="form-group">
                <label for="json-upload">Import External JSON</label>
                <input type="file" id="json-upload" accept=".json,.txt" onchange="handleFileUpload(event)">
                <p style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                    Upload JSON files from external sources. Works with messy/broken JSON too!
                </p>
            </div>
            <div class="form-group">
                <label for="json-paste">Or Paste JSON Data</label>
                <textarea id="json-paste" rows="4" placeholder="Paste any JSON here - even if it's messy, has comments, or is broken..."></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-blue" onclick="importFromTextarea()">Import JSON</button>
                    <button class="btn btn-red" onclick="clearAllData()">Clear Form</button>
                </div>
            </div>
            <div id="upload-status" style="display: none;"></div>
        </div>
        
        <div class="facility-controls">
            <div class="facility-header">
                <div>
                    <strong>Current Facility: <span id="facility-counter">1 of 1</span></strong>
                </div>
                <div class="controls">
                    <button class="btn btn-green" onclick="addFacility()">Add Facility</button>
                    <button class="btn btn-red" onclick="removeFacility()" id="remove-facility-btn" style="display: none;">Remove Current</button>
                </div>
            </div>
            <div class="facility-selector" id="facility-selector" style="display: none;"></div>
        </div>
        
        <!-- Operator Information Section -->
        <div class="section" id="operator-section">
            <div class="section-header" onclick="toggleSection('operator-section')">
                <h2 class="section-title">Operator Information</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label for="operator-name">Operator Name</label>
                    <input type="text" id="operator-name" placeholder="e.g., Wayne Halfway House">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="operator-location">Operator Location</label>
                        <input type="text" id="operator-location" placeholder="e.g., Waynesboro, TN">
                    </div>
                    <div class="form-group">
                        <label for="operator-period">Operating Period</label>
                        <input type="text" id="operator-period" placeholder="e.g., 1992-Present">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Identification Section -->
        <div class="section" id="identification-section">
            <div class="section-header" onclick="toggleSection('identification-section')">
                <h2 class="section-title">Identification & Names</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="facility-field" data-field="identification.name">
                    </div>
                    <div class="form-group">
                        <label>Current Name</label>
                        <input type="text" class="facility-field" data-field="identification.currentName">
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Operator</label>
                    <input type="text" class="facility-field" data-field="identification.currentOperator">
                </div>
                <div class="form-group">
                    <label>Past Names</label>
                    <div class="array-container" data-array="identification.pastNames"></div>
                </div>
            </div>
        </div>
        
        <!-- Location Section -->
        <div class="section" id="location-section">
            <div class="section-header" onclick="toggleSection('location-section')">
                <h2 class="section-title">Location & Address</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" class="facility-field" data-field="location">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea class="facility-field" data-field="address" rows="3"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Operations Section -->
        <div class="section" id="operations-section">
            <div class="section-header" onclick="toggleSection('operations-section')">
                <h2 class="section-title">Operations</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Past Operators</label>
                    <div class="array-container" data-array="pastOperators"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Year</label>
                        <input type="number" class="facility-field" data-field="operatingPeriod.startYear">
                    </div>
                    <div class="form-group">
                        <label>End Year</label>
                        <input type="number" class="facility-field" data-field="operatingPeriod.endYear">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <input type="text" class="facility-field" data-field="operatingPeriod.status">
                </div>
            </div>
        </div>
        
        <!-- Staff Section -->
        <div class="section" id="staff-section">
            <div class="section-header" onclick="toggleSection('staff-section')">
                <h2 class="section-title">Staff & Links</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Administrator</label>
                    <div class="array-container" data-array="staff.administrator"></div>
                </div>
                <div class="form-group">
                    <label>Notable Staff</label>
                    <div class="array-container" data-array="staff.notableStaff"></div>
                </div>
                <div class="form-group">
                    <label>Profile Links</label>
                    <div class="array-container" data-array="profileLinks"></div>
                </div>
            </div>
        </div>
        
        <!-- Facility Details Section -->
        <div class="section" id="facility-section">
            <div class="section-header" onclick="toggleSection('facility-section')">
                <h2 class="section-title">Facility Details</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Type</label>
                    <input type="text" class="facility-field" data-field="facilityDetails.type">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.capacity">
                    </div>
                    <div class="form-group">
                        <label>Current Census</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.currentCensus">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Min Age</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.ageRange.min">
                    </div>
                    <div class="form-group">
                        <label>Max Age</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.ageRange.max">
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select class="facility-field" data-field="facilityDetails.gender">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="coed">Co-ed</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Memberships Section -->
        <div class="section" id="memberships-section">
            <div class="section-header" onclick="toggleSection('memberships-section')">
                <h2 class="section-title">Memberships & Accreditations</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <div class="array-container" data-array="membershipsAccreditations"></div>
                </div>
            </div>
        </div>
        
        <!-- Incidents Section -->
        <div class="section" id="incidents-section">
            <div class="section-header" onclick="toggleSection('incidents-section')">
                <h2 class="section-title">Incidents</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <div class="array-container" data-array="incidents"></div>
                </div>
            </div>
        </div>
        
        <!-- Documents Section -->
        <div class="section" id="documents-section">
            <div class="section-header" onclick="toggleSection('documents-section')">
                <h2 class="section-title">Documents</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="document-grid" id="documents-grid"></div>
            </div>
        </div>
        
        <!-- Notes Section -->
        <div class="section" id="notes-section">
            <div class="section-header" onclick="toggleSection('notes-section')">
                <h2 class="section-title">Notes</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <div class="array-container" data-array="notes"></div>
                </div>
            </div>
        </div>
        
        <!-- JSON Output Section -->
        <div class="section" id="output-section">
            <div class="section-header" onclick="toggleSection('output-section')">
                <h2 class="section-title">JSON Output</h2>
                <span class="section-toggle">▼</span>
            </div>
            <div class="section-content">
                <div class="json-output">
                    <div class="output-header">
                        <h3>Generated JSON</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="copy-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
                            <button class="copy-btn" onclick="downloadJSON()">Download JSON</button>
                        </div>
                    </div>
                    <pre id="json-display">{}</pre>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let formData = {
            operator: {
                name: "",
                location: "",
                operatingPeriod: ""
            },
            facilities: [{
                identification: {
                    name: "",
                    currentName: "",
                    currentOperator: "",
                    pastNames: []
                },
                location: "",
                address: "",
                pastOperators: [],
                operatingPeriod: {
                    startYear: null,
                    endYear: null,
                    status: ""
                },
                staff: {
                    administrator: [],
                    notableStaff: []
                },
                profileLinks: [],
                facilityDetails: {
                    type: "",
                    capacity: null,
                    currentCensus: null,
                    ageRange: {
                        min: null,
                        max: null
                    },
                    gender: ""
                },
                membershipsAccreditations: [],
                incidents: [],
                documents: {
                    parentManual: {
                        available: false,
                        year: null,
                        notes: ""
                    },
                    studentManual: {
                        available: false,
                        year: null,
                        notes: ""
                    },
                    staffManual: {
                        available: false,
                        year: null,
                        notes: ""
                    },
                    newsArticles: {
                        available: false,
                        count: 0,
                        notes: ""
                    },
                    stateReports: {
                        available: false,
                        count: 0,
                        notes: ""
                    },
                    lawsuit: {
                        available: false,
                        count: 0,
                        notes: ""
                    },
                    testimonials: {
                        available: false,
                        count: 0,
                        notes: ""
                    }
                },
                notes: []
            }]
        };
        
        let currentFacilityIndex = 0;
        let currentProjectId = null;
        let currentProjectName = 'Untitled';
        let isAutoSaving = false;
        
        // UTILITY FUNCTIONS
        function deepClone(obj) {
            if (obj === null || typeof obj !== 'object') return obj;
            if (obj instanceof Date) return new Date(obj.getTime());
            if (Array.isArray(obj)) return obj.map(item => deepClone(item));
            
            const cloned = {};
            Object.keys(obj).forEach(key => {
                cloned[key] = deepClone(obj[key]);
            });
            return cloned;
        }

        function sanitizeValue(value, fieldPath) {
            // Handle null/undefined
            if (value === null || value === undefined) {
                return null;
            }

            // Convert empty strings to appropriate types based on field path
            if (value === "") {
                // Numeric fields should be null when empty
                if (fieldPath.includes('Year') || 
                    fieldPath.includes('capacity') || 
                    fieldPath.includes('census') || 
                    fieldPath.includes('min') || 
                    fieldPath.includes('max') ||
                    fieldPath.includes('year')) {
                    return null;
                }
                // Count fields should be 0 when empty
                if (fieldPath.includes('count')) {
                    return 0;
                }
                // String fields can be empty
                return "";
            }

            // Convert string numbers to actual numbers for numeric fields
            if (typeof value === 'string' && !isNaN(value) && value.trim() !== '') {
                if (fieldPath.includes('Year') || 
                    fieldPath.includes('capacity') || 
                    fieldPath.includes('census') || 
                    fieldPath.includes('min') || 
                    fieldPath.includes('max') ||
                    fieldPath.includes('year') ||
                    fieldPath.includes('count')) {
                    return parseInt(value);
                }
            }

            // Clean strings - remove extra whitespace and newlines
            if (typeof value === 'string') {
                return value.replace(/\\n+/g, ' ').trim();
            }

            return value;
        }

        function cleanDataStructure(obj, path = '') {
            if (Array.isArray(obj)) {
                return obj.map((item, index) => cleanDataStructure(item, `${path}[${index}]`));
            }
            
            if (obj !== null && typeof obj === 'object') {
                const cleaned = {};
                Object.keys(obj).forEach(key => {
                    const newPath = path ? `${path}.${key}` : key;
                    cleaned[key] = cleanDataStructure(obj[key], newPath);
                });
                return cleaned;
            }
            
            return sanitizeValue(obj, path);
        }

        // IMPROVED JSON PROCESSING
        function preprocessJSON(jsonString) {
            if (typeof jsonString !== 'string') return '{}';
            
            let cleaned = jsonString.trim();
            if (!cleaned) return '{}';
            
            try {
                // Remove comments (// and /* */)
                cleaned = cleaned.replace(/\/\*[\s\S]*?\*\//g, '');
                cleaned = cleaned.replace(/\/\/.*$/gm, '');
                
                // Fix control characters in strings - this is the key fix for the parsing error
                // Replace literal newlines, tabs, and other control characters within quoted strings
                cleaned = cleaned.replace(/"([^"]*?)\\n\\n([^"]*?)"/g, '"$1 $2"'); // Remove double newlines
                cleaned = cleaned.replace(/"([^"]*?)\\n([^"]*?)"/g, '"$1 $2"');     // Remove single newlines
                cleaned = cleaned.replace(/"([^"]*?)\\t([^"]*?)"/g, '"$1 $2"');     // Remove tabs
                
                // Handle actual newline/tab characters (not escaped) within strings
                cleaned = cleaned.replace(/"([^"]*?)\n\n([^"]*?)"/g, '"$1 $2"');
                cleaned = cleaned.replace(/"([^"]*?)\n([^"]*?)"/g, '"$1 $2"');
                cleaned = cleaned.replace(/"([^"]*?)\t([^"]*?)"/g, '"$1 $2"');
                
                // Remove other control characters that might cause issues
                cleaned = cleaned.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ' ');
                
                // Fix unquoted keys (be more specific to avoid breaking strings)
                cleaned = cleaned.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*(?=:)/g, '$1"$2"');
                
                // Remove trailing commas (more comprehensive)
                cleaned = cleaned.replace(/,(\s*[}\]])/g, '$1');
                
                // Fix malformed JSON endings - handle cases like "},\n}" or "},]}" 
                cleaned = cleaned.replace(/,\s*}\s*,\s*$/g, '}'); // Remove trailing },}
                cleaned = cleaned.replace(/,\s*}\s*$/g, '}');     // Remove trailing },
                cleaned = cleaned.replace(/,\s*]\s*,\s*$/g, ']'); // Remove trailing ],}
                cleaned = cleaned.replace(/,\s*]\s*$/g, ']');     // Remove trailing ],
                
                // Ensure proper JSON structure ending
                if (!cleaned.endsWith('}') && !cleaned.endsWith(']')) {
                    // If it doesn't end properly, try to fix common patterns
                    cleaned = cleaned.replace(/,\s*$/, ''); // Remove trailing comma
                    
                    // Count braces to see what's missing
                    const openBraces = (cleaned.match(/\{/g) || []).length;
                    const closeBraces = (cleaned.match(/\}/g) || []).length;
                    const openBrackets = (cleaned.match(/\[/g) || []).length;
                    const closeBrackets = (cleaned.match(/\]/g) || []).length;
                    
                    // Add missing closing brackets/braces
                    for (let i = closeBrackets; i < openBrackets; i++) {
                        cleaned += ']';
                    }
                    for (let i = closeBraces; i < openBraces; i++) {
                        cleaned += '}';
                    }
                }
                
                // Clean up extra whitespace
                cleaned = cleaned.replace(/\s+/g, ' ');
                
                // Try to find JSON within text (if pasted from a larger document)
                const jsonMatch = cleaned.match(/[\[{].*[\]}]/s);
                if (jsonMatch) {
                    cleaned = jsonMatch[0];
                }
                
                return cleaned || '{}';
            } catch (e) {
                console.error('Preprocessing error:', e);
                return jsonString; // Return original if preprocessing fails
            }
        }

        function adaptJSONStructure(data) {
            if (!data || typeof data !== 'object') {
                data = {};
            }
            
            // Default structure template
            const defaultStructure = {
                operator: {
                    name: "",
                    location: "",
                    operatingPeriod: ""
                },
                facilities: [{
                    identification: { name: "", currentName: "", currentOperator: "", pastNames: [] },
                    location: "",
                    address: "",
                    pastOperators: [],
                    operatingPeriod: { startYear: null, endYear: null, status: "" },
                    staff: { administrator: [], notableStaff: [] },
                    profileLinks: [],
                    facilityDetails: {
                        type: "", capacity: null, currentCensus: null,
                        ageRange: { min: null, max: null }, gender: ""
                    },
                    membershipsAccreditations: [],
                    incidents: [],
                    documents: {
                        parentManual: { available: false, year: null, notes: "" },
                        studentManual: { available: false, year: null, notes: "" },
                        staffManual: { available: false, year: null, notes: "" },
                        newsArticles: { available: false, count: 0, notes: "" },
                        stateReports: { available: false, count: 0, notes: "" },
                        lawsuit: { available: false, count: 0, notes: "" },
                        testimonials: { available: false, count: 0, notes: "" }
                    },
                    notes: []
                }]
            };
            
            try {
                // Case 1: Already in correct format (has operator and facilities)
                if (data && data.operator && data.facilities && Array.isArray(data.facilities)) {
                    const result = mergeWithDefaults(defaultStructure, data);
                    return cleanDataStructure(result);
                }
                
                // Case 2: Just a single facility object
                if (data && (data.identification || data.location || data.facilityDetails || data.documents)) {
                    const result = deepClone(defaultStructure);
                    result.facilities[0] = mergeWithDefaults(result.facilities[0], data);
                    return cleanDataStructure(result);
                }
                
                // Case 3: Array of facilities
                if (Array.isArray(data) && data.length > 0) {
                    const result = deepClone(defaultStructure);
                    result.facilities = data.map(facility => {
                        if (!facility || typeof facility !== 'object') return deepClone(defaultStructure.facilities[0]);
                        return mergeWithDefaults(deepClone(defaultStructure.facilities[0]), facility);
                    });
                    return cleanDataStructure(result);
                }
                
                // Case 4: Operator-only data
                if (data && (data.name || data.location || data.operatingPeriod)) {
                    const result = deepClone(defaultStructure);
                    result.operator = mergeWithDefaults(result.operator, data);
                    return cleanDataStructure(result);
                }
                
                // Case 5: Try to merge anything that looks facility-related
                const result = deepClone(defaultStructure);
                if (data.operatorName) result.operator.name = data.operatorName;
                if (data.operatorLocation) result.operator.location = data.operatorLocation;
                
                result.facilities[0] = mergeWithDefaults(result.facilities[0], data);
                return cleanDataStructure(result);
                
            } catch (e) {
                console.error('Error adapting JSON structure:', e);
                return cleanDataStructure(defaultStructure);
            }
        }

        function mergeWithDefaults(defaultObj, sourceObj) {
            if (!defaultObj || typeof defaultObj !== 'object') {
                return sourceObj || {};
            }
            if (!sourceObj || typeof sourceObj !== 'object') {
                return deepClone(defaultObj);
            }
            
            const result = deepClone(defaultObj);
            
            try {
                Object.keys(sourceObj).forEach(key => {
                    const sourceValue = sourceObj[key];
                    if (sourceValue !== undefined && sourceValue !== null && sourceValue !== "") {
                        if (typeof result[key] === 'object' && !Array.isArray(result[key]) && 
                            typeof sourceValue === 'object' && !Array.isArray(sourceValue)) {
                            result[key] = mergeWithDefaults(result[key], sourceValue);
                        } else if (Array.isArray(result[key]) && Array.isArray(sourceValue)) {
                            result[key] = [...sourceValue];
                        } else if (Array.isArray(result[key]) && !Array.isArray(sourceValue)) {
                            result[key] = [sourceValue];
                        } else {
                            result[key] = sourceValue;
                        }
                    } else if (sourceValue === "") {
                        // Handle empty strings based on expected type
                        if (typeof result[key] === 'number' || result[key] === null) {
                            // Don't overwrite null/number fields with empty strings
                        } else {
                            result[key] = sourceValue;
                        }
                    }
                });
            } catch (e) {
                console.error('Error merging objects:', e);
            }
            
            return result;
        }

        function attemptDataRecovery(text) {
            if (!text || typeof text !== 'string') return null;
            
            try {
                console.log('Attempting data recovery...');
                
                // First try to fix the most common issues and structure problems
                let cleanedText = text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, ' ');
                cleanedText = cleanedText.replace(/"([^"]*?)\n+([^"]*?)"/g, '"$1 $2"');
                
                // Fix the malformed ending - this is crucial for Brown Schools JSON
                cleanedText = cleanedText.replace(/,\s*}\s*,?\s*$/, '}]}');
                cleanedText = cleanedText.replace(/}\s*,\s*$/, '}]}');
                
                // Try direct parse first
                try {
                    const directParse = JSON.parse(cleanedText);
                    console.log('Direct parse successful after cleaning');
                    return adaptJSONStructure(directParse);
                } catch (e) {
                    console.log('Direct parse failed:', e.message.substring(0, 100));
                }
                
                const recoveredData = {
                    operator: { name: "", location: "", operatingPeriod: "" },
                    facilities: []
                };
                
                // Extract operator info
                const operatorMatch = cleanedText.match(/"operator"\s*:\s*\{[^{}]*?"name"\s*:\s*"([^"]*)"[^{}]*?\}/);
                if (operatorMatch) {
                    recoveredData.operator.name = operatorMatch[1] || "";
                }
                
                // NEW APPROACH: Find all facility name instances and extract surrounding context
                console.log('Starting comprehensive facility extraction...');
                
                const facilityNameRegex = /"identification"\s*:\s*\{\s*"name"\s*:\s*"([^"]+)"/g;
                const facilityNames = [];
                let nameMatch;
                
                while ((nameMatch = facilityNameRegex.exec(cleanedText)) !== null) {
                    facilityNames.push({
                        name: nameMatch[1],
                        startIndex: nameMatch.index
                    });
                }
                
                console.log(`Found ${facilityNames.length} facility names:`, facilityNames.map(f => f.name));
                
                if (facilityNames.length === 0) {
                    console.log('No facility names found, aborting recovery');
                    return null;
                }
                
                // For each facility name, try to extract the complete facility object
                for (let i = 0; i < facilityNames.length; i++) {
                    const currentFacility = facilityNames[i];
                    const nextFacility = facilityNames[i + 1];
                    
                    try {
                        let facilityStart = currentFacility.startIndex;
                        
                        // Find the opening brace for this facility object
                        while (facilityStart > 0 && cleanedText[facilityStart] !== '{') {
                            facilityStart--;
                        }
                        
                        let facilityEnd;
                        if (nextFacility) {
                            // End just before the next facility
                            facilityEnd = nextFacility.startIndex;
                            while (facilityEnd > facilityStart && cleanedText[facilityEnd - 1] !== '}') {
                                facilityEnd--;
                            }
                        } else {
                            // This is the last facility, find the end of the object
                            facilityEnd = cleanedText.length;
                            
                            // Look backwards for the last closing brace
                            for (let j = cleanedText.length - 1; j > facilityStart; j--) {
                                if (cleanedText[j] === '}') {
                                    facilityEnd = j + 1;
                                    break;
                                }
                            }
                        }
                        
                        let facilityText = cleanedText.substring(facilityStart, facilityEnd).trim();
                        
                        // Clean up the facility text
                        facilityText = facilityText.replace(/,$/, ''); // Remove trailing comma
                        
                        // Ensure it's a proper JSON object
                        if (!facilityText.endsWith('}')) {
                            facilityText += '}';
                        }
                        
                        // Count and balance braces
                        let openBraces = 0;
                        let closeBraces = 0;
                        let inString = false;
                        
                        for (let j = 0; j < facilityText.length; j++) {
                            const char = facilityText[j];
                            if (char === '"' && facilityText[j-1] !== '\\') {
                                inString = !inString;
                            } else if (!inString) {
                                if (char === '{') openBraces++;
                                else if (char === '}') closeBraces++;
                            }
                        }
                        
                        // Add missing closing braces
                        while (closeBraces < openBraces) {
                            facilityText += '}';
                            closeBraces++;
                        }
                        
                        // Try to parse this facility
                        const facility = JSON.parse(facilityText);
                        
                        if (facility && facility.identification && facility.identification.name) {
                            // Standardize the facility structure
                            const standardFacility = {
                                identification: {
                                    name: facility.identification.name || "",
                                    currentName: facility.identification.currentName || "",
                                    currentOperator: facility.identification.currentOperator || "",
                                    pastNames: facility.identification.pastNames || []
                                },
                                location: facility.location || "",
                                address: facility.address || "",
                                pastOperators: facility.pastOperators || [],
                                operatingPeriod: {
                                    startYear: facility.operatingPeriod?.startYear || null,
                                    endYear: facility.operatingPeriod?.endYear || null,
                                    status: facility.operatingPeriod?.status || "unknown"
                                },
                                staff: {
                                    administrator: facility.staff?.administrator || [],
                                    notableStaff: facility.staff?.notableStaff || []
                                },
                                profileLinks: facility.profileLinks || [],
                                facilityDetails: {
                                    type: facility.facilityDetails?.type || "",
                                    capacity: facility.facilityDetails?.capacity || null,
                                    currentCensus: facility.facilityDetails?.currentCensus || null,
                                    ageRange: {
                                        min: facility.facilityDetails?.ageRange?.min || null,
                                        max: facility.facilityDetails?.ageRange?.max || null
                                    },
                                    gender: facility.facilityDetails?.gender || ""
                                },
                                membershipsAccreditations: facility.membershipsAccreditations || [],
                                incidents: facility.incidents || [],
                                documents: facility.documents || {
                                    parentManual: { available: false, year: null, notes: "" },
                                    studentManual: { available: false, year: null, notes: "" },
                                    staffManual: { available: false, year: null, notes: "" },
                                    newsArticles: { available: false, count: 0, notes: "" },
                                    stateReports: { available: false, count: 0, notes: "" },
                                    lawsuit: { available: false, count: 0, notes: "" },
                                    testimonials: { available: false, count: 0, notes: "" }
                                },
                                notes: facility.notes || []
                            };
                            
                            recoveredData.facilities.push(standardFacility);
                            console.log(`Successfully recovered facility ${i + 1}: ${facility.identification.name}`);
                        }
                        
                    } catch (e) {
                        console.log(`Failed to recover facility ${i + 1} (${currentFacility.name}):`, e.message.substring(0, 100));
                        
                        // If parsing failed, create a minimal facility with just the name
                        recoveredData.facilities.push({
                            identification: {
                                name: currentFacility.name,
                                currentName: "",
                                currentOperator: "",
                                pastNames: []
                            },
                            location: "",
                            address: "",
                            pastOperators: [],
                            operatingPeriod: { startYear: null, endYear: null, status: "unknown" },
                            staff: { administrator: [], notableStaff: [] },
                            profileLinks: [],
                            facilityDetails: {
                                type: "", capacity: null, currentCensus: null,
                                ageRange: { min: null, max: null }, gender: ""
                            },
                            membershipsAccreditations: [],
                            incidents: [],
                            documents: {
                                parentManual: { available: false, year: null, notes: "" },
                                studentManual: { available: false, year: null, notes: "" },
                                staffManual: { available: false, year: null, notes: "" },
                                newsArticles: { available: false, count: 0, notes: "" },
                                stateReports: { available: false, count: 0, notes: "" },
                                lawsuit: { available: false, count: 0, notes: "" },
                                testimonials: { available: false, count: 0, notes: "" }
                            },
                            notes: []
                        });
                        console.log(`Created minimal facility entry for: ${currentFacility.name}`);
                    }
                }
                
                if (recoveredData.facilities.length > 0 || recoveredData.operator.name) {
                    console.log(`Recovery successful: ${recoveredData.facilities.length} facilities, operator: ${recoveredData.operator.name}`);
                    return recoveredData; // Return directly, don't call adaptJSONStructure again
                }
                
                return null;
            } catch (e) {
                console.error('Data recovery failed:', e);
                return null;
            }
        }

        function loadJSONData(jsonString) {
            if (!jsonString || jsonString.trim() === '') {
                showUploadStatus('No data provided', 'error');
                return;
            }
            
            console.log('Loading JSON data, length:', jsonString.length);
            showUploadStatus('Processing large dataset...', 'info');
            
            // Use setTimeout to prevent UI blocking for large files
            setTimeout(() => {
                try {
                    // Step 1: Preprocess the JSON
                    console.log('Preprocessing JSON...');
                    const cleanedJson = preprocessJSON(jsonString);
                    
                    // Step 2: Try parsing
                    console.log('Parsing JSON...');
                    let data;
                    
                    try {
                        data = JSON.parse(cleanedJson);
                        console.log('JSON parsed successfully');
                    } catch (parseError) {
                        console.log('Initial parse failed:', parseError.message);
                        
                        // Try recovery
                        console.log('Attempting recovery...');
                        const recoveredData = attemptDataRecovery(jsonString);
                        if (recoveredData) {
                            data = recoveredData;
                            showUploadStatus('Partially recovered data from malformed JSON. Please verify the results.', 'info');
                        } else {
                            throw parseError;
                        }
                    }
                    
                    // Step 3: Adapt structure
                    console.log('Adapting JSON structure...');
                    let loadedData = adaptJSONStructure(data);
                    
                    // Step 4: Load the adapted data
                    const facilityCount = loadedData.facilities.length;
                    console.log(`Loading ${facilityCount} facilities...`);
                    
                    if (facilityCount > 20) {
                        showUploadStatus(`Processing ${facilityCount} facilities... This may take a moment.`, 'info');
                    }
                    
                    formData = loadedData;
                    currentFacilityIndex = 0;
                    
                    // Step 5: Clear the textarea
                    document.getElementById('json-paste').value = '';
                    
                    // Step 6: Update all UI elements (optimized for large datasets)
                    setTimeout(() => {
                        loadOperatorData();
                        loadFacilityData();
                        updateFacilityControls();
                        
                        // Defer JSON display update for very large files
                        setTimeout(() => {
                            updateJSON();
                        }, 100);
                        
                        let successMessage = `Successfully loaded ${facilityCount} facilities.`;
                        if (facilityCount > 50) {
                            successMessage += ' Large dataset loaded successfully. Use facility navigation to browse through all entries.';
                        }
                        
                        showUploadStatus(successMessage, 'success');
                    }, 50);
                    
                } catch (error) {
                    console.error('JSON loading failed:', error);
                    
                    let errorDetails = `Error: ${error.message}`;
                    const fileSizeMB = (jsonString.length / 1024 / 1024).toFixed(1);
                    if (jsonString.length > 100000) {
                        errorDetails += `\n\nFile size: ${fileSizeMB}MB`;
                    }
                    
                    showUploadStatus(`Could not parse the data. ${errorDetails}`, 'error', errorDetails);
                }
            }, 10);
        }

        // PROJECT MANAGEMENT FUNCTIONS
        function saveCurrentProject() {
            const projectName = document.getElementById('project-name').value.trim();
            if (!projectName) {
                showUploadStatus('Please enter a project name', 'error');
                return;
            }
            
            const projectId = currentProjectId || generateProjectId();
            const project = {
                id: projectId,
                name: projectName,
                data: deepClone(formData),
                createdAt: currentProjectId ? getSavedProjects()[projectId].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            saveProject(project);
            currentProjectId = projectId;
            currentProjectName = projectName;
            document.getElementById('project-name').value = '';
            
            updateProjectDisplay();
            updateProjectsList();
            showUploadStatus(`Project "${projectName}" saved successfully!`, 'success');
        }
        
        function saveProject(project) {
            const projects = getSavedProjects();
            projects[project.id] = project;
            localStorage.setItem('facilityFormProjects', JSON.stringify(projects));
        }
        
        function getSavedProjects() {
            try {
                const saved = localStorage.getItem('facilityFormProjects');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }
        
        function loadProject(projectId) {
            const projects = getSavedProjects();
            const project = projects[projectId];
            if (!project) return;
            
            formData = deepClone(project.data);
            currentFacilityIndex = 0;
            currentProjectId = project.id;
            currentProjectName = project.name;
            
            loadOperatorData();
            loadFacilityData();
            updateFacilityControls();
            updateJSON();
            updateProjectDisplay();
            updateProjectsList();
            
            showUploadStatus(`Project "${project.name}" loaded successfully!`, 'success');
        }
        
        function deleteProject(projectId) {
            const projects = getSavedProjects();
            const project = projects[projectId];
            if (!project) return;
            
            if (confirm(`Are you sure you want to delete project "${project.name}"? This cannot be undone.`)) {
                delete projects[projectId];
                localStorage.setItem('facilityFormProjects', JSON.stringify(projects));
                
                if (currentProjectId === projectId) {
                    newProject();
                }
                
                updateProjectsList();
                showUploadStatus(`Project "${project.name}" deleted.`, 'success');
            }
        }
        
        function newProject() {
            if (currentProjectId && hasUnsavedChanges()) {
                if (!confirm('You have unsaved changes. Start a new project anyway?')) {
                    return;
                }
            }
            
            currentProjectId = null;
            currentProjectName = 'Untitled';
            clearAllData(false);
            updateProjectDisplay();
            updateProjectsList();
        }
        
        function generateProjectId() {
            return 'project_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function hasUnsavedChanges() {
            if (!currentProjectId) return false;
            const projects = getSavedProjects();
            const saved = projects[currentProjectId];
            if (!saved) return true;
            return JSON.stringify(formData) !== JSON.stringify(saved.data);
        }
        
        function updateProjectDisplay() {
            const info = document.getElementById('current-project-info');
            const nameSpan = document.getElementById('current-project-name');
            const lastSaved = document.getElementById('last-saved');
            
            nameSpan.textContent = currentProjectName;
            info.style.display = 'block';
            
            if (currentProjectId) {
                const projects = getSavedProjects();
                const project = projects[currentProjectId];
                if (project) {
                    const date = new Date(project.updatedAt).toLocaleString();
                    lastSaved.textContent = `Last saved: ${date}`;
                } else {
                    lastSaved.textContent = 'Last saved: Never';
                }
            } else {
                lastSaved.textContent = 'Last saved: Never';
            }
        }
        
        function updateProjectsList() {
            const container = document.getElementById('projects-list');
            const projects = getSavedProjects();
            const projectArray = Object.values(projects).sort((a, b) => 
                new Date(b.updatedAt) - new Date(a.updatedAt)
            );
            
            if (projectArray.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No saved projects yet.</p>';
                return;
            }
            
            container.innerHTML = projectArray.map(project => {
                const isCurrentProject = project.id === currentProjectId;
                const date = new Date(project.updatedAt).toLocaleDateString();
                const facilities = project.data.facilities ? project.data.facilities.length : 0;
                const operatorName = project.data.operator ? project.data.operator.name : '';
                
                return `
                    <div class="project-item ${isCurrentProject ? 'current' : ''}">
                        <div class="project-info">
                            <div class="project-name">${project.name}</div>
                            <div class="project-meta">
                                ${operatorName ? `${operatorName} • ` : ''}${facilities} facilities • Updated ${date}
                            </div>
                        </div>
                        <div class="project-actions">
                            ${!isCurrentProject ? `<button class="btn btn-blue btn-small" onclick="loadProject('${project.id}')">Load</button>` : '<span style="font-size: 12px; color: #2563eb; font-weight: 500;">Current</span>'}
                            <button class="btn btn-red btn-small" onclick="deleteProject('${project.id}')">Delete</button>
                            <button class="btn btn-green btn-small" onclick="exportProject('${project.id}')">Export</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function exportProject(projectId) {
            const projects = getSavedProjects();
            const project = projects[projectId];
            if (!project) return;
            
            const jsonString = JSON.stringify(project.data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Auto-save functionality
        function enableAutoSave() {
            let autoSaveTimeout;
            
            function doAutoSave() {
                if (!currentProjectId || isAutoSaving) return;
                isAutoSaving = true;
                
                const projects = getSavedProjects();
                const currentProject = projects[currentProjectId];
                if (currentProject) {
                    currentProject.data = deepClone(formData);
                    currentProject.updatedAt = new Date().toISOString();
                    saveProject(currentProject);
                    updateProjectDisplay();
                }
                
                isAutoSaving = false;
            }
            
            function scheduleAutoSave() {
                if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(doAutoSave, 2000);
            }
            
            document.addEventListener('input', scheduleAutoSave);
            document.addEventListener('change', scheduleAutoSave);
        }

        // FORM DATA FUNCTIONS
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            section.classList.toggle('expanded');
        }
        
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key] !== undefined ? current[key] : null, obj);
        }
        
        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            const lastKey = keys.pop();
            const target = keys.reduce((current, key) => {
                if (!current[key]) current[key] = {};
                return current[key];
            }, obj);
            
            // Use sanitizeValue to handle type conversion
            target[lastKey] = sanitizeValue(value, path);
        }
        
        function updateJSON() {
            // For very large datasets, add a delay to prevent UI blocking
            const facilityCount = formData.facilities.length;
            if (facilityCount > 30) {
                setTimeout(() => {
                    document.getElementById('json-display').textContent = JSON.stringify(formData, null, 2);
                }, 50);
            } else {
                document.getElementById('json-display').textContent = JSON.stringify(formData, null, 2);
            }
        }
        
        function updateFacilityControls() {
            const counter = document.getElementById('facility-counter');
            const selector = document.getElementById('facility-selector');
            const removeBtn = document.getElementById('remove-facility-btn');
            const totalFacilities = formData.facilities.length;
            
            counter.textContent = `${currentFacilityIndex + 1} of ${totalFacilities}`;
            
            if (totalFacilities > 1) {
                selector.style.display = 'flex';
                removeBtn.style.display = 'inline-block';
                
                selector.innerHTML = '';
                
                // For large datasets (50+ facilities), show navigation controls instead of all buttons
                if (totalFacilities > 50) {
                    // Add navigation controls for large datasets
                    const navContainer = document.createElement('div');
                    navContainer.style.display = 'flex';
                    navContainer.style.alignItems = 'center';
                    navContainer.style.gap = '10px';
                    navContainer.style.flexWrap = 'wrap';
                    
                    // Previous/Next buttons
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'facility-btn';
                    prevBtn.textContent = '◀ Previous';
                    prevBtn.disabled = currentFacilityIndex === 0;
                    prevBtn.onclick = () => switchFacility(currentFacilityIndex - 1);
                    navContainer.appendChild(prevBtn);
                    
                    // Current facility info
                    const currentInfo = document.createElement('span');
                    currentInfo.style.padding = '8px 16px';
                    currentInfo.style.background = '#f8fafc';
                    currentInfo.style.borderRadius = '6px';
                    currentInfo.style.fontSize = '14px';
                    currentInfo.style.fontWeight = '500';
                    const currentName = formData.facilities[currentFacilityIndex].identification?.name || `Facility ${currentFacilityIndex + 1}`;
                    currentInfo.textContent = currentName.length > 30 ? currentName.substring(0, 30) + '...' : currentName;
                    navContainer.appendChild(currentInfo);
                    
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'facility-btn';
                    nextBtn.textContent = 'Next ▶';
                    nextBtn.disabled = currentFacilityIndex === totalFacilities - 1;
                    nextBtn.onclick = () => switchFacility(currentFacilityIndex + 1);
                    navContainer.appendChild(nextBtn);
                    
                    // Jump to facility dropdown
                    const jumpSelect = document.createElement('select');
                    jumpSelect.style.padding = '6px 10px';
                    jumpSelect.style.borderRadius = '4px';
                    jumpSelect.style.border = '1px solid #d1d5db';
                    jumpSelect.style.fontSize = '14px';
                    jumpSelect.style.marginLeft = '15px';
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Jump to facility...';
                    jumpSelect.appendChild(defaultOption);
                    
                    formData.facilities.forEach((facility, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        const name = facility.identification?.name || `Facility ${index + 1}`;
                        option.textContent = `${index + 1}. ${name}`;
                        jumpSelect.appendChild(option);
                    });
                    
                    jumpSelect.onchange = function() {
                        if (this.value !== '') {
                            switchFacility(parseInt(this.value));
                            this.value = '';
                        }
                    };
                    navContainer.appendChild(jumpSelect);
                    
                    selector.appendChild(navContainer);
                    
                } else if (totalFacilities > 20) {
                    // For medium datasets (20-50), show current +/- 5 facilities and navigation
                    const start = Math.max(0, currentFacilityIndex - 5);
                    const end = Math.min(totalFacilities, currentFacilityIndex + 6);
                    
                    // Add "First" button if not at start
                    if (start > 0) {
                        const firstBtn = document.createElement('button');
                        firstBtn.className = 'facility-btn';
                        firstBtn.textContent = '1';
                        firstBtn.onclick = () => switchFacility(0);
                        selector.appendChild(firstBtn);
                        
                        if (start > 1) {
                            const ellipsis = document.createElement('span');
                            ellipsis.textContent = '...';
                            ellipsis.style.padding = '8px';
                            selector.appendChild(ellipsis);
                        }
                    }
                    
                    // Show range around current facility
                    for (let i = start; i < end; i++) {
                        const btn = document.createElement('button');
                        btn.className = `facility-btn ${i === currentFacilityIndex ? 'active' : ''}`;
                        const name = formData.facilities[i].identification?.name || `Facility ${i + 1}`;
                        btn.textContent = name.length > 12 ? `${i + 1}` : (name.length > 8 ? name.substring(0, 8) + '...' : name);
                        btn.title = name; // Show full name on hover
                        btn.onclick = () => switchFacility(i);
                        selector.appendChild(btn);
                    }
                    
                    // Add "Last" button if not at end
                    if (end < totalFacilities) {
                        if (end < totalFacilities - 1) {
                            const ellipsis = document.createElement('span');
                            ellipsis.textContent = '...';
                            ellipsis.style.padding = '8px';
                            selector.appendChild(ellipsis);
                        }
                        
                        const lastBtn = document.createElement('button');
                        lastBtn.className = 'facility-btn';
                        lastBtn.textContent = totalFacilities.toString();
                        lastBtn.onclick = () => switchFacility(totalFacilities - 1);
                        selector.appendChild(lastBtn);
                    }
                    
                } else {
                    // For smaller datasets (2-20), show all facility buttons
                    formData.facilities.forEach((facility, index) => {
                        const btn = document.createElement('button');
                        btn.className = `facility-btn ${index === currentFacilityIndex ? 'active' : ''}`;
                        const name = facility.identification?.name || `Facility ${index + 1}`;
                        btn.textContent = name.length > 15 ? name.substring(0, 15) + '...' : name;
                        btn.title = name; // Show full name on hover
                        btn.onclick = () => switchFacility(index);
                        selector.appendChild(btn);
                    });
                }
            } else {
                selector.style.display = 'none';
                removeBtn.style.display = 'none';
            }
        }
        
        function switchFacility(index) {
            currentFacilityIndex = index;
            loadFacilityData();
            updateFacilityControls();
        }
        
        function addFacility() {
            const newFacility = JSON.parse(JSON.stringify(formData.facilities[0]));
            resetFacilityData(newFacility);
            formData.facilities.push(newFacility);
            currentFacilityIndex = formData.facilities.length - 1;
            loadFacilityData();
            updateFacilityControls();
            updateJSON();
        }
        
        function removeFacility() {
            if (formData.facilities.length > 1) {
                formData.facilities.splice(currentFacilityIndex, 1);
                if (currentFacilityIndex >= formData.facilities.length) {
                    currentFacilityIndex = formData.facilities.length - 1;
                }
                loadFacilityData();
                updateFacilityControls();
                updateJSON();
            }
        }
        
        function resetFacilityData(facility) {
            facility.identification = { name: "", currentName: "", currentOperator: "", pastNames: [] };
            facility.location = "";
            facility.address = "";
            facility.pastOperators = [];
            facility.operatingPeriod = { startYear: null, endYear: null, status: "" };
            facility.staff = { administrator: [], notableStaff: [] };
            facility.profileLinks = [];
            facility.facilityDetails = { type: "", capacity: null, currentCensus: null, ageRange: { min: null, max: null }, gender: "" };
            facility.membershipsAccreditations = [];
            facility.incidents = [];
            facility.documents = {
                parentManual: { available: false, year: null, notes: "" },
                studentManual: { available: false, year: null, notes: "" },
                staffManual: { available: false, year: null, notes: "" },
                newsArticles: { available: false, count: 0, notes: "" },
                stateReports: { available: false, count: 0, notes: "" },
                lawsuit: { available: false, count: 0, notes: "" },
                testimonials: { available: false, count: 0, notes: "" }
            };
            facility.notes = [];
        }
        
        function loadFacilityData() {
            const currentFacility = formData.facilities[currentFacilityIndex];
            
            document.querySelectorAll('.facility-field').forEach(field => {
                const path = field.dataset.field;
                const value = getNestedValue(currentFacility, path);
                field.value = value === null ? '' : value;
            });
            
            document.querySelectorAll('[data-array]').forEach(container => {
                const path = container.dataset.array;
                const array = getNestedValue(currentFacility, path) || [];
                renderArray(container, path, array);
            });
            
            renderDocuments();
        }
        
        function renderArray(container, path, items) {
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'array-item';
                div.innerHTML = `
                    <input type="text" value="${item}" onchange="updateArrayItem('${path}', ${index}, this.value)">
                    <button class="btn btn-red" onclick="removeArrayItem('${path}', ${index})">Remove</button>
                `;
                container.appendChild(div);
            });
            
            const addButton = document.createElement('button');
            addButton.className = 'add-item-btn';
            addButton.textContent = 'Add Item';
            addButton.onclick = () => addArrayItem(path);
            container.appendChild(addButton);
        }
        
        function updateArrayItem(path, index, value) {
            const array = getNestedValue(formData.facilities[currentFacilityIndex], path);
            array[index] = value;
            updateJSON();
        }
        
        function addArrayItem(path) {
            const array = getNestedValue(formData.facilities[currentFacilityIndex], path);
            array.push('');
            const container = document.querySelector(`[data-array="${path}"]`);
            renderArray(container, path, array);
            updateJSON();
        }
        
        function removeArrayItem(path, index) {
            const array = getNestedValue(formData.facilities[currentFacilityIndex], path);
            array.splice(index, 1);
            const container = document.querySelector(`[data-array="${path}"]`);
            renderArray(container, path, array);
            updateJSON();
        }
        
        function renderDocuments() {
            const grid = document.getElementById('documents-grid');
            const documents = formData.facilities[currentFacilityIndex].documents;
            
            grid.innerHTML = '';
            
            Object.entries(documents).forEach(([docType, docData]) => {
                const card = document.createElement('div');
                card.className = 'document-card';
                
                const title = docType.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const isManual = ['parentManual', 'studentManual', 'staffManual'].includes(docType);
                
                card.innerHTML = `
                    <h4>${title}</h4>
                    <div class="checkbox-group">
                        <input type="checkbox" id="${docType}-available" ${docData.available ? 'checked' : ''} onchange="updateDocument('${docType}', 'available', this.checked)">
                        <label for="${docType}-available">Available</label>
                    </div>
                    <div class="form-group">
                        <label>${isManual ? 'Year' : 'Count'}</label>
                        <input type="number" value="${isManual ? (docData.year || '') : (docData.count || '')}" onchange="updateDocument('${docType}', '${isManual ? 'year' : 'count'}', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea value="${docData.notes}" onchange="updateDocument('${docType}', 'notes', this.value)" rows="3">${docData.notes}</textarea>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function updateDocument(docType, field, value) {
            const doc = formData.facilities[currentFacilityIndex].documents[docType];
            if (field === 'available') {
                doc[field] = value;
            } else if (field === 'year' || field === 'count') {
                doc[field] = value === '' ? (field === 'count' ? 0 : null) : parseInt(value);
            } else {
                doc[field] = value;
            }
            updateJSON();
        }

        // FILE HANDLING
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                loadJSONData(content);
            };
            reader.readAsText(file);
        }
        
        function importFromTextarea() {
            const content = document.getElementById('json-paste').value.trim();
            if (!content) {
                showUploadStatus('Please paste some JSON data first.', 'error');
                return;
            }
            loadJSONData(content);
        }

        // OUTPUT FUNCTIONS
        function copyToClipboard() {
            const text = JSON.stringify(formData, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        function downloadJSON() {
            const jsonString = JSON.stringify(formData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            const operatorName = formData.operator.name || 'facility-data';
            const date = new Date().toISOString().split('T')[0];
            const filename = `${operatorName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${date}.json`;
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function loadOperatorData() {
            document.getElementById('operator-name').value = formData.operator.name || '';
            document.getElementById('operator-location').value = formData.operator.location || '';
            document.getElementById('operator-period').value = formData.operator.operatingPeriod || '';
        }
        
        function clearAllData(askConfirmation = true) {
            if (askConfirmation && !confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }
            
            formData = {
                operator: { name: "", location: "", operatingPeriod: "" },
                facilities: [{
                    identification: { name: "", currentName: "", currentOperator: "", pastNames: [] },
                    location: "", address: "", pastOperators: [],
                    operatingPeriod: { startYear: null, endYear: null, status: "" },
                    staff: { administrator: [], notableStaff: [] }, profileLinks: [],
                    facilityDetails: { type: "", capacity: null, currentCensus: null, ageRange: { min: null, max: null }, gender: "" },
                    membershipsAccreditations: [], incidents: [],
                    documents: {
                        parentManual: { available: false, year: null, notes: "" },
                        studentManual: { available: false, year: null, notes: "" },
                        staffManual: { available: false, year: null, notes: "" },
                        newsArticles: { available: false, count: 0, notes: "" },
                        stateReports: { available: false, count: 0, notes: "" },
                        lawsuit: { available: false, count: 0, notes: "" },
                        testimonials: { available: false, count: 0, notes: "" }
                    },
                    notes: []
                }]
            };
            
            currentFacilityIndex = 0;
            loadOperatorData();
            loadFacilityData();
            updateFacilityControls();
            updateJSON();
            document.getElementById('json-paste').value = '';
            
            if (askConfirmation) {
                showUploadStatus('All data has been cleared.', 'success');
            }
        }
        
        function showUploadStatus(message, type, debugInfo = null) {
            const statusDiv = document.getElementById('upload-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = message;
            
            statusDiv.className = 'upload-status ' + type;
            
            if (debugInfo && (type === 'error' || type === 'info')) {
                const debugDiv = document.createElement('div');
                debugDiv.className = 'debug-info';
                debugDiv.innerHTML = `<strong>Debug Info:</strong><br><pre>${debugInfo}</pre>`;
                statusDiv.appendChild(debugDiv);
            }
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, type === 'error' ? 10000 : 5000);
        }
        
        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            // Set up operator field listeners
            ['operator-name', 'operator-location', 'operator-period'].forEach(id => {
                const field = document.getElementById(id);
                const dataField = id.replace('operator-', '');
                field.addEventListener('input', function() {
                    formData.operator[dataField === 'period' ? 'operatingPeriod' : dataField] = this.value;
                    updateJSON();
                });
            });
            
            // Set up facility field listeners
            document.querySelectorAll('.facility-field').forEach(field => {
                field.addEventListener('input', function() {
                    const path = this.dataset.field;
                    setNestedValue(formData.facilities[currentFacilityIndex], path, this.value);
                    updateJSON();
                });
            });
            
            // Initialize project system
            updateProjectDisplay();
            updateProjectsList();
            enableAutoSave();
            
            // Open key sections by default
            document.getElementById('operator-section').classList.add('expanded');
            document.getElementById('output-section').classList.add('expanded');
            
            loadOperatorData();
            loadFacilityData();
            updateFacilityControls();
            updateJSON();
            
            console.log('Facility Data Entry Form initialized successfully');
        });
    </script>
</body>
</html>
