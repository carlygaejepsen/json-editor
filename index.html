<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Data Entry Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #f7fafc;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d3748;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            padding: 40px;
            border: 1px solid #4a5568;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #68d391, #4fd1c7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        /* Project Management - Always Visible */
        .project-section {
            background: linear-gradient(135deg, #553c9a 0%, #6b46c1 100%);
            border: none;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            color: #f7fafc;
            box-shadow: 0 8px 32px rgba(107, 70, 193, 0.3);
        }
        
        .project-section h2 {
            color: #f7fafc;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        /* Form Sections - Collapsible */
        .form-section {
            border: none;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            background: #4a5568;
        }
        
        .section-header {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            padding: 18px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.3s ease;
            color: #f7fafc;
        }
        
        .section-header:hover {
            background: linear-gradient(135deg, #0a6b4f 0%, #059669 100%);
            transform: translateY(-1px);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #f7fafc;
        }
        
        .section-arrow {
            font-size: 14px;
            transition: transform 0.3s ease;
            color: rgba(247, 250, 252, 0.9);
        }
        
        .section-content {
            padding: 25px;
            display: none;
            background: #4a5568;
            color: #f7fafc;
        }
        
        .form-section.open .section-content {
            display: block;
        }
        
        .form-section.open .section-arrow {
            transform: rotate(180deg);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #718096;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #2d3748;
            color: #f7fafc;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #68d391;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.2);
            transform: translateY(-1px);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-green { 
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            color: #B2D7C7;
        }
        .btn-green:hover { 
            background: linear-gradient(135deg, #059669 0%, #0a6b4f 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(4, 120, 87, 0.4);
        }
        
        .btn-blue { 
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            color: ##33A7B5;
        }
        .btn-blue:hover { 
            background: linear-gradient(135deg, #2563eb 0%, #4338ca 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
        }
        
        .btn-red { 
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
            color: #f7fafc;
        }
        .btn-red:hover { 
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(153, 27, 27, 0.4);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Array handling */
        .array-container {
            border: 2px solid #718096;
            border-radius: 8px;
            padding: 20px;
            background: linear-gradient(135deg, #553c9a 0%, #6b46c1 100%);
        }
        
        .array-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .array-item input {
            flex: 1;
            background: #2d3748;
            border-color: #718096;
            color: #f7fafc;
        }
        
        /* Project items */
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 2px solid rgba(113, 128, 150, 0.3);
            border-radius: 10px;
            margin-bottom: 12px;
            background: rgba(45, 55, 72, 0.6);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #f7fafc;
        }
        
        .project-item:hover {
            background: rgba(74, 85, 104, 0.8);
            transform: translateY(-2px);
        }
        
        .project-item.current {
            background: rgba(104, 211, 145, 0.2);
            border-color: rgba(104, 211, 145, 0.6);
            box-shadow: 0 8px 25px rgba(104, 211, 145, 0.2);
        }
        
        /* Documents grid */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .document-card {
            border: none;
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            box-shadow: 0 8px 32px rgba(30, 64, 175, 0.3);
            transition: transform 0.3s ease;
            color: #f7fafc;
        }
        
        .document-card:hover {
            transform: translateY(-4px);
        }
        
        .document-card h4 {
            margin-bottom: 15px;
            color: #f7fafc;
            font-weight: 600;
        }
        
        .document-card input, .document-card textarea {
            background: white;
            color: #2d3748;
        }
        
        /* JSON output */
        .json-output {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border: 2px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            color: #f7fafc;
            box-shadow: 0 8px 32px rgba(26, 32, 44, 0.5);
        }
        
        .json-output pre {
            background: rgba(26, 32, 44, 0.8);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            color: #68d391;
            backdrop-filter: blur(10px);
            border: 1px solid #4a5568;
        }
        
        .status-message {
            padding: 14px 18px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }
        
        .status-success {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            color: #f7fafc;
            box-shadow: 0 4px 20px rgba(4, 120, 87, 0.3);
        }
        
        .status-error {
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
            color: #f7fafc;
            box-shadow: 0 4px 20px rgba(153, 27, 27, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facility Data Entry Form</h1>
        
        <!-- Project Management Section - Always Visible -->
        <div class="project-section">
            <h2>Projects & Data Import</h2>
            
            <div class="form-group">
                <label>Project Management</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="text" id="project-name" placeholder="Enter project name..." style="flex: 1; min-width: 200px;">
                    <button class="btn btn-green" onclick="saveProject()">Save Project</button>
                    <button class="btn btn-blue" onclick="newProject()">New Project</button>
                </div>
                
                <div id="current-project" style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none;">
                    <strong>Current:</strong> <span id="current-name">Untitled</span>
                    <span style="font-size: 12px; color: #64748b; margin-left: 10px;" id="last-saved">Never saved</span>
                </div>
                
                <div id="projects-list"></div>
            </div>
            
            <hr style="margin: 20px 0; border: 1px solid #e2e8f0;">
            
            <div class="form-group">
                <label>Import JSON Data</label>
                <input type="file" id="json-file" accept=".json,.txt" onchange="importFile(event)">
                <p style="color: #6b7280; font-size: 14px; margin-top: 8px;">Upload any JSON file - works with messy formats too!</p>
                
                <textarea id="json-paste" rows="4" placeholder="Or paste JSON data here..." style="margin-top: 15px;"></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-blue" onclick="importJSON()">Import</button>
                    <button class="btn btn-red" onclick="clearForm()">Clear All</button>
                </div>
            </div>
            
            <div id="status" class="status-message"></div>
        </div>
        
        <!-- Facility Controls -->
        <div id="facility-controls" style="background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 8px 32px rgba(30, 64, 175, 0.4); color: #f7fafc;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <strong style="color: #f7fafc; font-size: 16px;">Facility: <span id="facility-counter">1 of 1</span></strong>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-green" onclick="addFacility()">Add Facility</button>
                    <button class="btn btn-red" onclick="removeFacility()" id="remove-btn" style="display: none;">Remove Current</button>
                </div>
            </div>
            <div id="facility-tabs" style="margin-top: 20px; display: none;"></div>
        </div>
        
        <!-- Form Sections - These are collapsible -->
        <div class="form-section open" id="operator-section">
            <div class="section-header" onclick="toggleSection('operator-section')">
                <h3 class="section-title">Operator Information</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Operator Name</label>
                    <input type="text" id="op-name" placeholder="e.g., Wayne Halfway House">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="op-location" placeholder="e.g., Waynesboro, TN">
                    </div>
                    <div class="form-group">
                        <label>Operating Period</label>
                        <input type="text" id="op-period" placeholder="e.g., 1992-Present">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="identification-section">
            <div class="section-header" onclick="toggleSection('identification-section')">
                <h3 class="section-title">Identification & Names</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="facility-field" data-field="identification.name">
                    </div>
                    <div class="form-group">
                        <label>Current Name</label>
                        <input type="text" class="facility-field" data-field="identification.currentName">
                    </div>
                </div>
                <div class="form-group">
                    <label>Current Operator</label>
                    <input type="text" class="facility-field" data-field="identification.currentOperator">
                </div>
                <div class="form-group">
                    <label>Past Names</label>
                    <div class="array-container" data-array="identification.pastNames"></div>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="location-section">
            <div class="section-header" onclick="toggleSection('location-section')">
                <h3 class="section-title">Location & Address</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" class="facility-field" data-field="location">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea class="facility-field" data-field="address" rows="3"></textarea>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="operations-section">
            <div class="section-header" onclick="toggleSection('operations-section')">
                <h3 class="section-title">Operations</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Past Operators</label>
                    <div class="array-container" data-array="pastOperators"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Year</label>
                        <input type="number" class="facility-field" data-field="operatingPeriod.startYear">
                    </div>
                    <div class="form-group">
                        <label>End Year</label>
                        <input type="number" class="facility-field" data-field="operatingPeriod.endYear">
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <input type="text" class="facility-field" data-field="operatingPeriod.status">
                </div>
            </div>
        </div>
        
        <div class="form-section" id="staff-section">
            <div class="section-header" onclick="toggleSection('staff-section')">
                <h3 class="section-title">Staff & Links</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Administrator</label>
                    <div class="array-container" data-array="staff.administrator"></div>
                </div>
                <div class="form-group">
                    <label>Notable Staff</label>
                    <div class="array-container" data-array="staff.notableStaff"></div>
                </div>
                <div class="form-group">
                    <label>Profile Links</label>
                    <div class="array-container" data-array="profileLinks"></div>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="facility-section">
            <div class="section-header" onclick="toggleSection('facility-section')">
                <h3 class="section-title">Facility Details</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label>Type</label>
                    <input type="text" class="facility-field" data-field="facilityDetails.type">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.capacity">
                    </div>
                    <div class="form-group">
                        <label>Current Census</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.currentCensus">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Min Age</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.ageRange.min">
                    </div>
                    <div class="form-group">
                        <label>Max Age</label>
                        <input type="number" class="facility-field" data-field="facilityDetails.ageRange.max">
                    </div>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select class="facility-field" data-field="facilityDetails.gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="coed">Co-ed</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="memberships-section">
            <div class="section-header" onclick="toggleSection('memberships-section')">
                <h3 class="section-title">Memberships & Accreditations</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <div class="array-container" data-array="membershipsAccreditations"></div>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="incidents-section">
            <div class="section-header" onclick="toggleSection('incidents-section')">
                <h3 class="section-title">Incidents</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <div class="array-container" data-array="incidents"></div>
                </div>
            </div>
        </div>
        
        <div class="form-section" id="documents-section">
            <div class="section-header" onclick="toggleSection('documents-section')">
                <h3 class="section-title">Documents</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="documents-grid" id="documents-grid"></div>
            </div>
        </div>
        
        <div class="form-section" id="notes-section">
            <div class="section-header" onclick="toggleSection('notes-section')">
                <h3 class="section-title">Notes</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="form-group">
                    <div class="array-container" data-array="notes"></div>
                </div>
            </div>
        </div>
        
        <div class="form-section open" id="output-section">
            <div class="section-header" onclick="toggleSection('output-section')">
                <h3 class="section-title">JSON Output</h3>
                <span class="section-arrow">▼</span>
            </div>
            <div class="section-content">
                <div class="json-output">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>Generated JSON</h4>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-blue btn-small" onclick="copyJSON()">Copy</button>
                            <button class="btn btn-green btn-small" onclick="downloadJSON()">Download</button>
                        </div>
                    </div>
                    <pre id="json-display">{}</pre>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Data structure
        let formData = {
            operator: { name: "", location: "", operatingPeriod: "" },
            facilities: [{
                identification: { name: "", currentName: "", currentOperator: "", pastNames: [] },
                location: "", address: "", pastOperators: [],
                operatingPeriod: { startYear: null, endYear: null, status: "" },
                staff: { administrator: [], notableStaff: [] },
                profileLinks: [], membershipsAccreditations: [], incidents: [],
                facilityDetails: {
                    type: "", capacity: null, currentCensus: null,
                    ageRange: { min: null, max: null }, gender: ""
                },
                documents: {
                    parentManual: { available: false, year: null, notes: "" },
                    studentManual: { available: false, year: null, notes: "" },
                    staffManual: { available: false, year: null, notes: "" },
                    newsArticles: { available: false, count: 0, notes: "" },
                    stateReports: { available: false, count: 0, notes: "" },
                    lawsuit: { available: false, count: 0, notes: "" },
                    testimonials: { available: false, count: 0, notes: "" }
                },
                notes: []
            }]
        };
        
        let currentFacilityIndex = 0;
        let currentProjectId = null;
        
        // Simple collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('open');
        }
        
        // Update JSON display
        function updateJSON() {
            document.getElementById('json-display').textContent = JSON.stringify(formData, null, 2);
        }
        
        // Get nested value
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => current && current[key] !== undefined ? current[key] : null, obj);
        }
        
        // Set nested value
        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            const lastKey = keys.pop();
            const target = keys.reduce((current, key) => {
                if (!current[key]) current[key] = {};
                return current[key];
            }, obj);
            
            if (value === "" && (typeof target[lastKey] === "number" || target[lastKey] === null)) {
                target[lastKey] = null;
            } else if (!isNaN(value) && value !== "" && (path.includes('Year') || path.includes('capacity') || path.includes('census') || path.includes('min') || path.includes('max') || path.includes('count'))) {
                target[lastKey] = parseInt(value);
            } else {
                target[lastKey] = value;
            }
        }
        
        // Array management
        function renderArray(container, path, items) {
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'array-item';
                div.innerHTML = `
                    <input type="text" value="${item}" onchange="updateArrayItem('${path}', ${index}, this.value)">
                    <button class="btn btn-red btn-small" onclick="removeArrayItem('${path}', ${index})">Remove</button>
                `;
                container.appendChild(div);
            });
            
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-green';
            addBtn.textContent = 'Add Item';
            addBtn.style.width = '100%';
            addBtn.style.marginTop = '10px';
            addBtn.onclick = () => addArrayItem(path);
            container.appendChild(addBtn);
        }
        
        function updateArrayItem(path, index, value) {
            const array = getNestedValue(formData.facilities[currentFacilityIndex], path);
            array[index] = value;
            updateJSON();
        }
        
        function addArrayItem(path) {
            const array = getNestedValue(formData.facilities[currentFacilityIndex], path);
            array.push('');
            const container = document.querySelector(`[data-array="${path}"]`);
            renderArray(container, path, array);
            updateJSON();
        }
        
        function removeArrayItem(path, index) {
            const array = getNestedValue(formData.facilities[currentFacilityIndex], path);
            array.splice(index, 1);
            const container = document.querySelector(`[data-array="${path}"]`);
            renderArray(container, path, array);
            updateJSON();
        }
        
        // Document handling
        function renderDocuments() {
            const grid = document.getElementById('documents-grid');
            const docs = formData.facilities[currentFacilityIndex].documents;
            
            grid.innerHTML = '';
            
            Object.entries(docs).forEach(([docType, docData]) => {
                const card = document.createElement('div');
                card.className = 'document-card';
                
                const title = docType.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const isManual = ['parentManual', 'studentManual', 'staffManual'].includes(docType);
                
                card.innerHTML = `
                    <h4>${title}</h4>
                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="checkbox" ${docData.available ? 'checked' : ''} onchange="updateDocument('${docType}', 'available', this.checked)" style="margin-right: 8px;">
                        Available
                    </label>
                    <div style="margin-bottom: 10px;">
                        <label>${isManual ? 'Year' : 'Count'}</label>
                        <input type="number" value="${isManual ? (docData.year || '') : (docData.count || '')}" onchange="updateDocument('${docType}', '${isManual ? 'year' : 'count'}', this.value)">
                    </div>
                    <div>
                        <label>Notes</label>
                        <textarea onchange="updateDocument('${docType}', 'notes', this.value)" rows="3">${docData.notes}</textarea>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function updateDocument(docType, field, value) {
            const doc = formData.facilities[currentFacilityIndex].documents[docType];
            if (field === 'available') {
                doc[field] = value;
            } else if (field === 'year' || field === 'count') {
                doc[field] = value === '' ? (field === 'count' ? 0 : null) : parseInt(value);
            } else {
                doc[field] = value;
            }
            updateJSON();
        }
        
        // Facility management
        function addFacility() {
            const newFacility = JSON.parse(JSON.stringify(formData.facilities[0]));
            resetFacility(newFacility);
            formData.facilities.push(newFacility);
            currentFacilityIndex = formData.facilities.length - 1;
            loadFacilityData();
            updateControls();
            updateJSON();
        }
        
        function removeFacility() {
            if (formData.facilities.length > 1) {
                formData.facilities.splice(currentFacilityIndex, 1);
                if (currentFacilityIndex >= formData.facilities.length) {
                    currentFacilityIndex = formData.facilities.length - 1;
                }
                loadFacilityData();
                updateControls();
                updateJSON();
            }
        }
        
        function resetFacility(facility) {
            facility.identification = { name: "", currentName: "", currentOperator: "", pastNames: [] };
            facility.location = ""; facility.address = ""; facility.pastOperators = [];
            facility.operatingPeriod = { startYear: null, endYear: null, status: "" };
            facility.staff = { administrator: [], notableStaff: [] };
            facility.profileLinks = []; facility.membershipsAccreditations = []; facility.incidents = [];
            facility.facilityDetails = { type: "", capacity: null, currentCensus: null, ageRange: { min: null, max: null }, gender: "" };
            facility.notes = [];
        }
        
        function updateControls() {
            const counter = document.getElementById('facility-counter');
            const removeBtn = document.getElementById('remove-btn');
            const tabs = document.getElementById('facility-tabs');
            
            counter.textContent = `${currentFacilityIndex + 1} of ${formData.facilities.length}`;
            removeBtn.style.display = formData.facilities.length > 1 ? 'inline-block' : 'none';
            
            if (formData.facilities.length > 1) {
                tabs.style.display = 'flex';
                tabs.innerHTML = '';
                formData.facilities.forEach((_, index) => {
                    const btn = document.createElement('button');
                    btn.className = `btn ${index === currentFacilityIndex ? 'btn-blue' : ''} btn-small`;
                    btn.style.backgroundColor = index === currentFacilityIndex ? '' : '#4a5568';
                    btn.style.color = '#f7fafc';
                    btn.style.border = '1px solid #718096';
                    btn.textContent = `Facility ${index + 1}`;
                    btn.onclick = () => switchFacility(index);
                    btn.style.marginRight = '10px';
                    tabs.appendChild(btn);
                });
            } else {
                tabs.style.display = 'none';
            }
        }
        
        function switchFacility(index) {
            currentFacilityIndex = index;
            loadFacilityData();
            updateControls();
        }
        
        // Load facility data into form
        function loadFacilityData() {
            const facility = formData.facilities[currentFacilityIndex];
            
            // Load regular fields
            document.querySelectorAll('.facility-field').forEach(field => {
                const path = field.dataset.field;
                const value = getNestedValue(facility, path);
                field.value = value || '';
            });
            
            // Load arrays
            document.querySelectorAll('[data-array]').forEach(container => {
                const path = container.dataset.array;
                const array = getNestedValue(facility, path) || [];
                renderArray(container, path, array);
            });
            
            renderDocuments();
        }
        
        // JSON utilities
        function copyJSON() {
            navigator.clipboard.writeText(JSON.stringify(formData, null, 2)).then(() => {
                showStatus('JSON copied to clipboard!', 'success');
            });
        }
        
        function downloadJSON() {
            const jsonString = JSON.stringify(formData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const name = formData.operator.name || 'facility-data';
            const date = new Date().toISOString().split('T')[0];
            a.download = `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Project management
        function saveProject() {
            const name = document.getElementById('project-name').value.trim();
            if (!name) {
                showStatus('Please enter a project name', 'error');
                return;
            }
            
            const projects = getProjects();
            const id = currentProjectId || 'project_' + Date.now();
            projects[id] = {
                id: id,
                name: name,
                data: JSON.parse(JSON.stringify(formData)),
                created: projects[id] ? projects[id].created : new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            localStorage.setItem('facilityProjects', JSON.stringify(projects));
            currentProjectId = id;
            document.getElementById('project-name').value = '';
            
            updateProjectDisplay();
            renderProjects();
            showStatus(`Project "${name}" saved!`, 'success');
        }
        
        function getProjects() {
            try {
                return JSON.parse(localStorage.getItem('facilityProjects') || '{}');
            } catch (e) {
                return {};
            }
        }
        
        function newProject() {
            currentProjectId = null;
            clearForm(false);
            updateProjectDisplay();
            renderProjects();
        }
        
        function loadProject(id) {
            const projects = getProjects();
            const project = projects[id];
            if (project) {
                formData = JSON.parse(JSON.stringify(project.data));
                currentFacilityIndex = 0;
                currentProjectId = id;
                
                loadOperatorData();
                loadFacilityData();
                updateControls();
                updateJSON();
                updateProjectDisplay();
                renderProjects();
                
                showStatus(`Project "${project.name}" loaded!`, 'success');
            }
        }
        
        function deleteProject(id) {
            const projects = getProjects();
            const project = projects[id];
            if (project && confirm(`Delete project "${project.name}"?`)) {
                delete projects[id];
                localStorage.setItem('facilityProjects', JSON.stringify(projects));
                if (currentProjectId === id) newProject();
                renderProjects();
                showStatus('Project deleted', 'success');
            }
        }
        
        function exportProject(id) {
            const projects = getProjects();
            const project = projects[id];
            if (project) {
                const jsonString = JSON.stringify(project.data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${project.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        function updateProjectDisplay() {
            const display = document.getElementById('current-project');
            const nameSpan = document.getElementById('current-name');
            const savedSpan = document.getElementById('last-saved');
            
            if (currentProjectId) {
                const projects = getProjects();
                const project = projects[currentProjectId];
                if (project) {
                    nameSpan.textContent = project.name;
                    savedSpan.textContent = 'Saved ' + new Date(project.updated).toLocaleString();
                    display.style.display = 'block';
                    return;
                }
            }
            
            nameSpan.textContent = 'Untitled';
            savedSpan.textContent = 'Never saved';
            display.style.display = 'block';
        }
        
        function renderProjects() {
            const container = document.getElementById('projects-list');
            const projects = Object.values(getProjects()).sort((a, b) => new Date(b.updated) - new Date(a.updated));
            
            if (projects.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No saved projects.</p>';
                return;
            }
            
            container.innerHTML = projects.map(project => {
                const isCurrent = project.id === currentProjectId;
                const date = new Date(project.updated).toLocaleDateString();
                const facilities = project.data.facilities ? project.data.facilities.length : 0;
                const operator = project.data.operator ? project.data.operator.name : '';
                
                return `
                    <div class="project-item ${isCurrent ? 'current' : ''}">
                        <div>
                            <strong>${project.name}</strong><br>
                            <small style="color: #6b7280;">
                                ${operator ? operator + ' • ' : ''}${facilities} facilities • ${date}
                            </small>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            ${!isCurrent ? `<button class="btn btn-blue btn-small" onclick="loadProject('${project.id}')">Load</button>` : '<span style="font-size: 12px; color: #2563eb;">Current</span>'}
                            <button class="btn btn-green btn-small" onclick="exportProject('${project.id}')">Export</button>
                            <button class="btn btn-red btn-small" onclick="deleteProject('${project.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Import/Export
        function importFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => loadJSONData(e.target.result);
            reader.readAsText(file);
        }
        
        function importJSON() {
            const content = document.getElementById('json-paste').value.trim();
            if (!content) {
                showStatus('Please paste JSON data first', 'error');
                return;
            }
            loadJSONData(content);
        }
        
        function loadJSONData(jsonString) {
            try {
                let data = JSON.parse(jsonString.trim());
                
                // Adapt various JSON structures
                if (!data.operator || !data.facilities) {
                    // Try to adapt the structure
                    const adapted = {
                        operator: { name: "", location: "", operatingPeriod: "" },
                        facilities: []
                    };
                    
                    if (Array.isArray(data)) {
                        adapted.facilities = data;
                    } else if (data.identification || data.location || data.facilityDetails) {
                        adapted.facilities = [data];
                    } else {
                        adapted.facilities = [{}];
                        if (data.name || data.location) {
                            Object.assign(adapted.operator, data);
                        }
                    }
                    
                    data = adapted;
                }
                
                formData = data;
                currentFacilityIndex = 0;
                currentProjectId = null;
                
                loadOperatorData();
                loadFacilityData();
                updateControls();
                updateJSON();
                updateProjectDisplay();
                
                document.getElementById('json-paste').value = '';
                showStatus('JSON data imported successfully!', 'success');
                
            } catch (error) {
                showStatus('Error parsing JSON: ' + error.message, 'error');
            }
        }
        
        function clearForm(confirm = true) {
            if (confirm && !window.confirm('Clear all data?')) return;
            
            formData = {
                operator: { name: "", location: "", operatingPeriod: "" },
                facilities: [{
                    identification: { name: "", currentName: "", currentOperator: "", pastNames: [] },
                    location: "", address: "", pastOperators: [],
                    operatingPeriod: { startYear: null, endYear: null, status: "" },
                    staff: { administrator: [], notableStaff: [] },
                    profileLinks: [], membershipsAccreditations: [], incidents: [],
                    facilityDetails: { type: "", capacity: null, currentCensus: null, ageRange: { min: null, max: null }, gender: "" },
                    documents: {
                        parentManual: { available: false, year: null, notes: "" },
                        studentManual: { available: false, year: null, notes: "" },
                        staffManual: { available: false, year: null, notes: "" },
                        newsArticles: { available: false, count: 0, notes: "" },
                        stateReports: { available: false, count: 0, notes: "" },
                        lawsuit: { available: false, count: 0, notes: "" },
                        testimonials: { available: false, count: 0, notes: "" }
                    },
                    notes: []
                }]
            };
            
            currentFacilityIndex = 0;
            currentProjectId = null;
            
            loadOperatorData();
            loadFacilityData();
            updateControls();
            updateJSON();
            updateProjectDisplay();
            
            if (confirm) showStatus('Form cleared', 'success');
        }
        
        function loadOperatorData() {
            document.getElementById('op-name').value = formData.operator.name || '';
            document.getElementById('op-location').value = formData.operator.location || '';
            document.getElementById('op-period').value = formData.operator.operatingPeriod || '';
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status-message status-${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Operator field listeners
            document.getElementById('op-name').addEventListener('input', function() {
                formData.operator.name = this.value;
                updateJSON();
            });
            
            document.getElementById('op-location').addEventListener('input', function() {
                formData.operator.location = this.value;
                updateJSON();
            });
            
            document.getElementById('op-period').addEventListener('input', function() {
                formData.operator.operatingPeriod = this.value;
                updateJSON();
            });
            
            // Facility field listeners
            document.querySelectorAll('.facility-field').forEach(field => {
                field.addEventListener('input', function() {
                    const path = this.dataset.field;
                    setNestedValue(formData.facilities[currentFacilityIndex], path, this.value);
                    updateJSON();
                });
            });
            
            loadOperatorData();
            loadFacilityData();
            updateControls();
            updateJSON();
            updateProjectDisplay();
            renderProjects();
        });
    </script>
</body>
</html>
